<!-- ðŸ§ª NPK Comparison Popup -->
<div id="npkPopupOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; width: 750px; position: relative; max-height: 80%; overflow: auto;">
        <h3 style="margin-top: 0;">Nutrient Comparison Over Time</h3>

        <!-- Filters -->
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <!-- Nutrient Checkboxes -->
            <div id="nutrientCheckboxes" style="flex: 1; overflow-y: auto; max-height: 200px;">
                <!-- Checkboxes will be dynamically created here -->
            </div>

            <!-- Month-Year Selector -->
            <div style="flex: 1;">
                <label for="monthSelector">Select Months</label>
                <select id="monthSelector" multiple class="form-select" style="height: 150px;"></select>
            </div>
        </div>

        <!-- Chart -->
        <canvas id="npkComparisonChart" width="700" height="350"></canvas>

        <!-- Close Button -->
        <button onclick="closeNpkPopup()" style="position: absolute; top: 10px; right: 15px;">âœ–</button>
    </div>
</div>

<!-- ðŸ§© Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<script>
    const SOIL_SAATHI_FIELDS_BAR_CHART = {
        nitrogen      : 'Nitrogen',
        phosphorous   : 'Phosphorous',
        potassium     : 'Potassium',
        calcium       : 'Calcium',
        magnesium     : 'Magnesium',
        sulphur       : 'Sulphur',
        zinc          : 'Zinc',
        manganese     : 'Manganese',
        iron          : 'Iron',
        copper        : 'Copper',
        boron         : 'Boron',
        molybdenum    : 'Molybdenum',
        chlorine      : 'Chlorine',
        nickel        : 'Nickel',
        organic_carboa: 'Organic Carbon',
        ph            : 'pH',
        ec            : 'EC',
        oc            : 'OC'
    };

    let npkBarChartInstance;
    let LineChartMonthChoices;

    // Dynamically generate checkboxes for nutrients
    function generateNutrientCheckboxes() {
        const nutrientCheckboxesDiv = document.getElementById("nutrientCheckboxes");
        for (const [key, value] of Object.entries(SOIL_SAATHI_FIELDS_BAR_CHART)) {
            const label     = document.createElement("label");
            label.innerHTML = `<input type="checkbox" value="${key}" checked /> ${value}`;
            nutrientCheckboxesDiv.appendChild(label);
            nutrientCheckboxesDiv.appendChild(document.createElement("br"));
        }
    }

    // Show the popup and prepare data
    async function showNpkPopup(devise_id) 
    {
        const npkData = await fetchDeviseApiData(devise_id)
        
        document.getElementById('npkPopupOverlay').style.display = 'flex';

        const monthSelector     = document.getElementById("monthSelector");
        monthSelector.innerHTML = ""; // Clear existing options

        // Creating month-year keys for selection (like Jan-2024, Feb-2024)
        const months = Object.keys(npkData);
        months.forEach(month => {
            const opt       = document.createElement("option");
            opt.value       = month;
            opt.textContent = month;
            monthSelector.appendChild(opt);
        });

        // Initialize Choices.js for multi-select (once)
        if (!LineChartMonthChoices) {
            LineChartMonthChoices = new Choices("#monthSelector", {
                removeItemButton: true,
                placeholderValue: "Select months",
                shouldSort: false
            });
        }

        // Event listeners for updates
        document.getElementById("nutrientCheckboxes").addEventListener("change", () => updateNpkChart(npkData));
        monthSelector.addEventListener("change", () => updateNpkChart(npkData));

        updateNpkChart(npkData);
    }

    // Update the chart when user selects different nutrients or months
    function updateNpkChart(npkData) {
    const selectedNutrients = [...document.querySelectorAll('#nutrientCheckboxes input:checked')].map(cb => cb.value);
    const selectedMonths    = LineChartMonthChoices ? LineChartMonthChoices.getValue(true) : [];

    if (!selectedNutrients.length || !selectedMonths.length) return;

    // Create a flat list of labels like "Jan-2024 #1", "Jan-2024 #2", etc.
    const labels          = [];
    const nutrientDataMap = {};

    selectedNutrients.forEach(nutrient => {
        nutrientDataMap[nutrient] = [];
    });

    selectedMonths.forEach(month => {
        const entries = npkData[month] || [];
        entries.forEach((entry, index) => {
            labels.push(`${month} #${index + 1}`);
            selectedNutrients.forEach(nutrient => {
                nutrientDataMap[nutrient].push(entry[nutrient]);
            });
        });
    });

    const colorPalette = ["#4caf50", "#2196f3", "#ff9800", "#e91e63", "#9c27b0", "#607d8b"];

    const datasets = selectedNutrients.map((nutrient, i) => ({
        label: SOIL_SAATHI_FIELDS_BAR_CHART[nutrient] || nutrient,
        data: nutrientDataMap[nutrient],
        backgroundColor: colorPalette[i % colorPalette.length],
        borderColor: colorPalette[i % colorPalette.length],
        fill: false,
        tension: 0.1
    }));

    const ctx = document.getElementById("npkComparisonChart").getContext("2d");
    if (npkBarChartInstance) npkBarChartInstance.destroy();

    npkBarChartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels  : labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins   : {
                tooltip: { mode: "index", intersect: false },
                legend : { position: 'bottom' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title      : {
                        display: true,
                        text   : "Nutrient Value"
                    }
                },
                x: {
                    title: {
                        display: true,
                        text   : "Month & Sample"
                    }
                }
            }
        }
    });
}


    // Close the popup
    function closeNpkPopup() {
        document.getElementById('npkPopupOverlay').style.display = 'none';
    }

    // Example mock data with month-year keys
    const mockNpkData = {
        "Jan-2024": [
            { 
                nitrogen: 45, 
                phosphorous: 30, 
                potassium: 25, 
                calcium: 12, 
                magnesium: 10, 
                sulphur: 5, 
                zinc: 2, 
                manganese: 3, 
                iron: 1, 
                copper: 0.5, 
                boron: 0.8, 
                molybdenum: 0.4, 
                chlorine: 0.7, 
                nickel: 0.3, 
                organic_carboa: 1.5, 
                ph: 6.5, 
                ec: 1.2, 
                oc: 1.0 
            },
            { 
                nitrogen: 50, 
                phosphorous: 30, 
                potassium: 25, 
                calcium: 12, 
                magnesium: 10, 
                sulphur: 5, 
                zinc: 2, 
                manganese: 3, 
                iron: 1, 
                copper: 0.5, 
                boron: 0.8, 
                molybdenum: 0.4, 
                chlorine: 0.7, 
                nickel: 0.3, 
                organic_carboa: 1.5, 
                ph: 6.5, 
                ec: 1.2, 
                oc: 1.0 
            },
            { 
                nitrogen: 46, 
                phosphorous: 31, 
                potassium: 26, 
                calcium: 13, 
                magnesium: 10.5, 
                sulphur: 5.5, 
                zinc: 2.1, 
                manganese: 3.1, 
                iron: 1.1, 
                copper: 0.6, 
                boron: 0.9, 
                molybdenum: 0.5, 
                chlorine: 0.8, 
                nickel: 0.4, 
                organic_carboa: 1.6, 
                ph: 6.6, 
                ec: 1.3, 
                oc: 1.1 
            }
        ],
        "Feb-2024": [
            { 
                nitrogen: 99, 
                phosphorous: 28, 
                potassium: 22, 
                calcium: 14, 
                magnesium: 11, 
                sulphur: 6, 
                zinc: 2.2, 
                manganese: 3.1, 
                iron: 1.2, 
                copper: 0.6, 
                boron: 1.0, 
                molybdenum: 0.5, 
                chlorine: 0.8, 
                nickel: 0.4, 
                organic_carboa: 1.6, 
                ph: 6.6, 
                ec: 1.3, 
                oc: 1.2 
            }
        ]
    };

    // Show popup with mock data
    generateNutrientCheckboxes();  // Add this line to generate the checkboxes

    async function fetchDeviseApiData(id) 
    {
        try {
            const base_url = `${window.location.protocol}//${window.location.host}`;
            const url      = `${base_url}/devise-api-calls-chart`;
            const response = await fetch(`${url}/${id}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Parse the JSON data
            const deviseData = await response.json();

            return deviseData.data

        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>
